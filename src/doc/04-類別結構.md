# 類別結構分析

## 📊 系統類別概覽

本系統總共包含 6 個主要類別，根據使用情況可分為：

- **活躍類別（3個）**：系統核心運行組件
- **未使用類別（3個）**：預備功能或輔助工具

## 🔥 活躍類別詳細分析

### 1. TrafficLightController.js

**系統角色**：核心控制器，整個交通模擬系統的大腦

**主要職責**：

- 管理整個十字路口的交通燈控制
- 協調車輛與燈號的交互
- 收集交通數據並與 AI 後端通訊
- 提供系統狀態的統一管理

**關鍵屬性**：

```javascript
class TrafficLightController {
  constructor() {
    this.trafficLights = {} // 四個方向的燈號實例
    this.vehicles = [] // 註冊的車輛列表
    this.currentPhase = 0 // 當前燈號相位
    this.phaseTimer = null // 相位計時器
    this.isAIMode = false // AI 模式開關
  }
}
```

**核心方法**：

- `registerVehicle(vehicle)`：註冊車輛為觀察者
- `updateTrafficLights(lightStates)`：更新燈號狀態
- `collectIntersectionData()`：收集交通數據
- `sendDataToAI()`：與 AI 後端通訊
- `switchLights()`：切換燈號相位

**設計模式應用**：

- **Singleton**：確保系統唯一控制中心
- **Observer**：管理車輛狀態通知
- **State**：燈號相位狀態管理

**與其他類別的關係**：

- 創建和管理 `TrafficLight` 實例
- 接收 `Vehicle` 的狀態通知
- 向 `Vehicle` 廣播燈號變化

### 2. Vehicle.js

**系統角色**：車輛實體類別，模擬真實車輛行為

**主要職責**：

- 模擬車輛的移動和轉彎行為
- 響應交通燈號變化
- 處理碰撞檢測和避讓行為
- 提供車輛狀態數據

**關鍵屬性**：

```javascript
class Vehicle {
  constructor(config, behavior, currentLights) {
    this.id = generateUniqueId() // 唯一識別碼
    this.type = config.type // 車輛類型
    this.direction = config.direction // 移動方向
    this.behavior = behavior // 行為模式
    this.currentState = 'waiting' // 當前狀態
    this.position = { x: 0, y: 0 } // 位置座標
    this.element = null // DOM 元素
    this.timeline = null // GSAP 動畫時間軸
  }
}
```

**核心方法**：

- `createVehicle(type, direction, behavior, currentLights)`：工廠方法
- `move()`：執行移動動畫
- `onTrafficLightChange(lightStates)`：響應燈號變化
- `canProceed(currentLights)`：判斷是否可通行
- `executeLeftTurn()` / `executeRightTurn()`：轉彎行為
- `checkCollision()`：碰撞檢測

**設計模式應用**：

- **Factory**：統一車輛創建邏輯
- **State**：車輛狀態管理
- **Strategy**：不同行為策略
- **Observer**：接收燈號變化通知
- **Command**：動畫命令封裝

**狀態轉換**：

```
waiting → moving → turning → completed → removed
   ↑                                        ↓
   ←━━━━━━━━━━━ collision detected ━━━━━━━━━━━┘
```

### 3. TrafficLight.js

**系統角色**：個別交通燈控制類別

**主要職責**：

- 管理單一方向的交通燈狀態
- 提供燈號的視覺表示
- 處理燈號狀態的安全轉換
- 支援不同的顯示模式

**關鍵屬性**：

```javascript
class TrafficLight {
  constructor(direction, container) {
    this.direction = direction // 燈號方向
    this.currentState = 'red' // 當前狀態
    this.element = null // DOM 元素
    this.container = container // 容器元素
    this.displayMode = 'normal' // 顯示模式
  }
}
```

**核心方法**：

- `setState(newState)`：設置燈號狀態
- `updateVisualState()`：更新視覺顯示
- `canTransitionTo(newState)`：驗證狀態轉換
- `setDisplayMode(mode)`：設置顯示模式

**設計模式應用**：

- **State**：燈號狀態管理
- **Strategy**：不同顯示策略
- **Command**：狀態變更命令
- **Facade**：簡化外部調用介面

**狀態轉換規則**：

```
red → green → yellow → red
 ↑                      ↓
 ←━━━━━━━━━━━━━━━━━━━━━━━━┘
```

## 💤 未使用類別分析

### 1. VehicleDataGenerator.js

**預期功能**：批量生成測試車輛數據
**未使用原因**：

- 當前系統採用即時生成機制
- 測試數據通過配置文件提供
- 批量數據生成功能暫未需要

**潛在用途**：

- 效能測試數據生成
- 壓力測試場景創建
- 歷史數據模擬重放

### 2. TrafficDataManager.js

**預期功能**：統一管理交通數據的存儲和檢索
**未使用原因**：

- 數據管理邏輯整合在 TrafficLightController 中
- 當前數據量較小，不需要專門的管理器
- 簡化架構減少不必要的複雜性

**潛在用途**：

- 大數據量的交通數據管理
- 數據持久化和緩存
- 多數據源整合

### 3. IntersectionDataProcessor.js

**預期功能**：處理複雜的路口數據分析
**未使用原因**：

- 當前系統只處理單一十字路口
- 數據處理邏輯相對簡單
- AI 後端承擔了主要的數據分析工作

**潛在用途**：

- 多路口數據整合分析
- 複雜交通模式識別
- 本地端數據預處理

## 🔗 類別間關係圖

```mermaid
classDiagram
    class TrafficLightController {
        +trafficLights: Map
        +vehicles: Array
        +registerVehicle()
        +updateTrafficLights()
        +collectIntersectionData()
    }

    class Vehicle {
        +type: String
        +direction: String
        +behavior: String
        +move()
        +onTrafficLightChange()
        +canProceed()
    }

    class TrafficLight {
        +direction: String
        +currentState: String
        +setState()
        +updateVisualState()
    }

    TrafficLightController ||--o{ TrafficLight : manages
    TrafficLightController ||--o{ Vehicle : observes
    Vehicle }o--|| TrafficLight : responds to
```

## 📈 類別職責矩陣

| 職責     | TrafficLightController | Vehicle     | TrafficLight |
| -------- | ---------------------- | ----------- | ------------ |
| 燈號控制 | ✅ 主要責任            | ❌          | ✅ 執行層面  |
| 車輛管理 | ✅ 註冊/通知           | ✅ 自我管理 | ❌           |
| 動畫處理 | ❌                     | ✅ 主要責任 | ✅ 狀態動畫  |
| 數據收集 | ✅ 主要責任            | ✅ 提供數據 | ✅ 狀態數據  |
| AI 通訊  | ✅ 主要責任            | ❌          | ❌           |
| 用戶介面 | ✅ 控制介面            | ❌          | ✅ 燈號顯示  |

## 🎯 類別設計優勢

### 清晰的職責分離

- 每個類別都有明確的單一職責
- 避免功能重疊和責任模糊
- 便於獨立測試和維護

### 合理的抽象層次

- **Controller**：系統協調層
- **Vehicle**：業務實體層
- **TrafficLight**：UI 組件層

### 良好的擴展性

- 新增車輛類型只需擴展 Vehicle 類別
- 新增燈號功能只需擴展 TrafficLight 類別
- 新增控制邏輯只需擴展 Controller 類別

### 高效的運行效能

- 最小化的類別數量減少記憶體開銷
- 精簡的方法調用鏈提升執行效率
- 合理的狀態管理避免不必要的更新

這種精簡而高效的類別結構設計，既滿足了當前系統的功能需求，又為未來的擴展預留了充分的空間。
